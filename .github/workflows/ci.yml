name: ðŸš€ Comprehensive CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      skip_cross_platform:
        description: 'Skip cross-platform testing (faster)'
        required: false
        default: false
        type: boolean
      skip_security:
        description: 'Skip security scanning'
        required: false
        default: false
        type: boolean

env:
  CARGO_TERM_COLOR: always

# Allow read access for all workflows
permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  # Core essential checks - always run
  core-ci:
    name: ðŸ”§ Core CI
    uses: ./.github/workflows/core-ci.yml
    
  # Security checks - run on push to main or if dependencies change
  security:
    name: ðŸ”’ Security
    if: |
      github.event_name == 'push' ||
      github.event.inputs.skip_security != 'true' ||
      contains(github.event.pull_request.changed_files, 'Cargo.lock') ||
      contains(github.event.pull_request.changed_files, 'Cargo.toml')
    uses: ./.github/workflows/security.yml
    
  # Quality and performance - run on code changes
  quality:
    name: ðŸ“Š Quality & Performance  
    needs: core-ci
    if: needs.core-ci.result == 'success'
    uses: ./.github/workflows/quality.yml
    
  # Cross-platform testing - can be skipped for faster feedback
  cross-platform:
    name: ðŸŒ Cross-Platform
    needs: core-ci
    if: |
      needs.core-ci.result == 'success' &&
      github.event.inputs.skip_cross_platform != 'true' &&
      (github.event_name == 'push' || github.event_name == 'schedule')
    uses: ./.github/workflows/cross-platform.yml

  # Final summary of all checks
  ci-summary:
    name: âœ… CI Summary
    runs-on: ubuntu-latest
    needs: [core-ci, security, quality, cross-platform]
    if: always()
    
    steps:
      - name: Comprehensive CI Status Summary
        run: |
          echo "## ðŸš€ Comprehensive CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          core_result="${{ needs.core-ci.result }}"
          security_result="${{ needs.security.result }}"
          quality_result="${{ needs.quality.result }}"
          platform_result="${{ needs.cross-platform.result }}"
          
          # Track which checks ran and their status
          all_success=true
          critical_failure=false
          
          echo "| Pipeline Stage | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|----------------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          
          # Core CI (critical)
          if [[ "$core_result" == "success" ]]; then
            echo "| ðŸ”§ Core CI | âœ… Passed | Format, lint, build, test, demos |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ”§ Core CI | âŒ Failed | Essential checks failed |" >> $GITHUB_STEP_SUMMARY
            all_success=false
            critical_failure=true
          fi
          
          # Security (important but not blocking for development)
          if [[ "$security_result" == "success" ]]; then
            echo "| ðŸ”’ Security | âœ… Passed | Audit, licenses, SBOM |" >> $GITHUB_STEP_SUMMARY
          elif [[ "$security_result" == "skipped" ]]; then
            echo "| ðŸ”’ Security | â­ï¸ Skipped | No dependency changes |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ”’ Security | âš ï¸ Issues | Security concerns detected |" >> $GITHUB_STEP_SUMMARY
            all_success=false
          fi
          
          # Quality (important for maintainability)
          if [[ "$quality_result" == "success" ]]; then
            echo "| ðŸ“Š Quality | âœ… Passed | Coverage, benchmarks, docs |" >> $GITHUB_STEP_SUMMARY
          elif [[ "$quality_result" == "skipped" ]]; then
            echo "| ðŸ“Š Quality | â­ï¸ Skipped | Waiting for core CI |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ“Š Quality | âš ï¸ Issues | Quality metrics below threshold |" >> $GITHUB_STEP_SUMMARY
            all_success=false
          fi
          
          # Cross-platform (nice to have)
          if [[ "$platform_result" == "success" ]]; then
            echo "| ðŸŒ Cross-Platform | âœ… Passed | Linux, Windows, macOS |" >> $GITHUB_STEP_SUMMARY
          elif [[ "$platform_result" == "skipped" ]]; then
            echo "| ðŸŒ Cross-Platform | â­ï¸ Skipped | Manual skip or dependency |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸŒ Cross-Platform | âš ï¸ Issues | Platform compatibility problems |" >> $GITHUB_STEP_SUMMARY
            all_success=false
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall status
          if [[ "$critical_failure" == "true" ]]; then
            echo "ðŸš¨ **Critical CI failure** - Core checks must pass before merge" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The essential CI checks (format, lint, build, test) have failed." >> $GITHUB_STEP_SUMMARY
            echo "Please fix these issues before proceeding." >> $GITHUB_STEP_SUMMARY
            echo "âŒ Critical CI failure - core checks must pass"
            exit 1
          elif [[ "$all_success" == "true" ]]; then
            echo "ðŸŽ‰ **All CI checks passed!** ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### âœ… Validation Complete" >> $GITHUB_STEP_SUMMARY
            echo "- **Core functionality**: Verified and working" >> $GITHUB_STEP_SUMMARY
            echo "- **Security**: No vulnerabilities detected" >> $GITHUB_STEP_SUMMARY
            echo "- **Quality**: Meets all standards" >> $GITHUB_STEP_SUMMARY
            echo "- **Compatibility**: Works across platforms" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**ðŸš€ Ready for merge!**" >> $GITHUB_STEP_SUMMARY
            echo "âœ… All CI checks passed! Ready for merge."
          else
            echo "âš ï¸ **Some CI checks have issues** âš ï¸" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "While core functionality works, some quality or compatibility" >> $GITHUB_STEP_SUMMARY
            echo "checks have detected issues. Review the details above." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Core CI passed** - merge is possible but issues should be addressed." >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ Some CI checks have issues but core functionality works"
          fi
          
          # Add performance information
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âš¡ Pipeline Performance" >> $GITHUB_STEP_SUMMARY
          echo "- **Parallel execution**: Multiple workflow stages run simultaneously" >> $GITHUB_STEP_SUMMARY
          echo "- **Intelligent skipping**: Workflows skip when not needed" >> $GITHUB_STEP_SUMMARY
          echo "- **Advanced caching**: Rust dependencies cached across jobs" >> $GITHUB_STEP_SUMMARY
          echo "- **Focused testing**: Only test what changed" >> $GITHUB_STEP_SUMMARY